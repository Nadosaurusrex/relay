# Relay Policy - Auto-generated from YAML
# Version: {{ version }}
# Generated: {{ timestamp }}

package {{ package_name }}

import future.keywords.if
import future.keywords.in

# Default deny
default allow := false

# Default reason
default reason := "No policy matched"

# Metadata
metadata := {
    "version": "{{ version }}",
    "generated_at": "{{ timestamp }}",
    "source": "{{ source_file }}"
}

{% for policy in policies %}
# Policy: {{ policy.name }}
{% for rule in policy.rules %}
# Rule: {{ rule.id }}
{% if rule.action == "allow" %}
allow if {
    {% for condition_key, condition_value in rule.condition.items() %}
    {% if condition_key == "provider" %}
    input.action.provider == "{{ condition_value }}"
    {% elif condition_key == "method" %}
    input.action.method == "{{ condition_value }}"
    {% elif condition_key == "parameter_constraints" %}
    {% for param_name, constraints in condition_value.items() %}
    {% if "max" in constraints %}
    input.action.parameters.{{ param_name }} <= {{ constraints.max }}
    {% endif %}
    {% if "min" in constraints %}
    input.action.parameters.{{ param_name }} >= {{ constraints.min }}
    {% endif %}
    {% if "equals" in constraints %}
    input.action.parameters.{{ param_name }} == {{ constraints.equals if constraints.equals is string else constraints.equals | tojson }}
    {% endif %}
    {% if "in" in constraints %}
    input.action.parameters.{{ param_name }} in {{ constraints.in | tojson }}
    {% endif %}
    {% endfor %}
    {% elif condition_key == "agent_id" %}
    input.agent.agent_id == "{{ condition_value }}"
    {% elif condition_key == "org_id" %}
    input.agent.org_id == "{{ condition_value }}"
    {% elif condition_key == "environment" %}
    input.environment == "{{ condition_value }}"
    {% endif %}
    {% endfor %}
}

{% elif rule.action == "deny" %}
# Denial rule: {{ rule.id }}
deny_{{ rule.id }} if {
    {% for condition_key, condition_value in rule.condition.items() %}
    {% if condition_key == "provider" %}
    input.action.provider == "{{ condition_value }}"
    {% elif condition_key == "method" %}
    input.action.method == "{{ condition_value }}"
    {% elif condition_key == "parameter_constraints" %}
    {% for param_name, constraints in condition_value.items() %}
    {% if "max" in constraints %}
    input.action.parameters.{{ param_name }} > {{ constraints.max }}
    {% endif %}
    {% if "min" in constraints %}
    input.action.parameters.{{ param_name }} >= {{ constraints.min }}
    {% endif %}
    {% endfor %}
    {% endif %}
    {% endfor %}
}

# Reason for denial: {{ rule.id }}
reason := "{{ rule.reason }}" if {
    deny_{{ rule.id }}
}
{% endif %}

{% endfor %}
{% endfor %}

# Fallback: deny if any deny rule matched
allow := false if {
    {% for policy in policies %}
    {% for rule in policy.rules %}
    {% if rule.action == "deny" %}
    deny_{{ rule.id }}
    {% endif %}
    {% endfor %}
    {% endfor %}
}
